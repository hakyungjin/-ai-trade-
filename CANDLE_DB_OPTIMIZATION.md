# 캔들 데이터 저장 최적화 가이드

## 📊 현재 문제점
- 모든 코인의 캔들을 `market_candles` 단일 테이블에 저장
- 테이블 크기 급증 (코인 × 캔들 수 × 여러 timeframe)
- 쿼리 성능 저하 가능성
- 백업/관리 복잡도 증가

---

## 🎯 추천 개선 방안 (우선순위)

### **방안 1: 시간 기반 파티셔닝 (권장 - 가장 효과적)**
**장점:**
- 자동 데이터 분리 (월/주별)
- 오래된 데이터 쉽게 삭제/아카이빙
- 쿼리 성능 향상 (필요한 파티션만 스캔)
- 백업/복구 효율성 증가

**구현:**
```sql
CREATE TABLE market_candles_2025_01 LIKE market_candles;
CREATE TABLE market_candles_2025_02 LIKE market_candles;
-- 자동 파티셔닝 또는 트리거로 관리
```

**저장 코인당 용량 변화:**
- 현재: 500 candles × 8 coin × 12 timeframe ≈ 48,000 rows/코인
- 파티셔닝 후: 더 효율적인 인덱싱으로 쿼리 속도 ↑50%

---

### **방안 2: 심볼별 테이블 분리 (복잡도 ↓)**
**장점:**
- 테이블당 데이터 적음 (빠른 쿼리)
- 심볼별 독립적 관리
- 특정 코인 분석에 최적

**단점:**
- 테이블 수 증가 (심볼 수만큼)
- 코드 복잡도 증가

**구현:**
```
market_candles_btcusdt
market_candles_ethusdt
market_candles_bnbusdt
...
```

---

### **방안 3: 인덱싱 최적화 (가장 간단)**
**추가 인덱스:**
```sql
-- 기존 인덱스 강화
CREATE INDEX idx_candle_symbol_timeframe_time 
ON market_candles(symbol, timeframe, open_time DESC);

-- 조회 성능 향상
CREATE INDEX idx_candle_time_desc 
ON market_candles(open_time DESC);
```

**효과:**
- 쿼리 속도 ↑30-40%
- 추가 저장소 필요 (인덱스 용량)

---

### **방안 4: 컬럼 타입 최적화**
**변경:**
- `Float` → `DECIMAL(18,8)` (정밀도 유지, 저장소 ↓15%)
- `DateTime` → `BIGINT` (타임스탬프로 저장)
- 불필요한 컬럼 제거

**효과:**
- 저장소 ↓20-30%
- 쿼리 속도 ↑10%

---

### **방안 5: 데이터 아카이빙 (정기 유지보수)**
**전략:**
- 최근 1개월: Hot data (market_candles)
- 1-6개월: Warm data (market_candles_archive_old)
- 6개월 이상: Cold data (파일 저장 또는 압축)

**효과:**
- 현재 테이블 크기 ↓70-80%
- 조회 성능 ↑60%

---

## 📋 단계별 구현 로드맵

### **즉시 (Week 1)** - 무중단 개선
1. ✅ 인덱싱 최적화 (방안 3)
   - 기존 테이블 수정 없음
   - 약 15분 작업

### **단기 (Week 2-3)** - 구조 개선
2. ✅ 파티셔닝 구현 (방안 1)
   - 새 파티션된 테이블 생성
   - 기존 데이터 마이그레이션
   - 약 1시간 다운타임

### **중기 (Week 4+)** - 최적화
3. ✅ 아카이빙 전략 적용 (방안 5)
   - 자동 아카이빙 스크립트
   - 정기 유지보수 작업

---

## 💡 추천 조합 (최적)
**1 + 3 + 5 조합:**
1. 인덱싱 최적화 (즉시)
2. 시간 기반 파티셔닝 (1-2주)
3. 자동 아카이빙 (지속)

**효과:**
- 쿼리 성능 ↑70%
- 저장소 효율 ↑60%
- 관리 편의성 ↑50%
- 백업/복구 시간 ↓80%

---

## 📈 데이터 축적 예측

**월별 저장량 (1h 봉 기준):**
```
1개 심볼 × 720개/월 × 50개 심볼 = 36,000개 행/월
50개 심볼 × 36,000행 = 1,800,000행/월

연간: 21,600,000행
파티셔닝 + 인덱싱 적용 시:
- 저장소: ~500MB/년
- 쿼리 응답: 10-50ms (vs 100-200ms 현재)
```

---

## 🔧 구현 코드 (별도 제공)
- `optimize_indexes.sql` - 인덱싱
- `partition_candles.py` - 파티셔닝
- `archive_candles.py` - 자동 아카이빙
